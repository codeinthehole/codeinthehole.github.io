<!doctype html>
<!--[if lt IE 7]><html class="no-js ie6 oldie" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js ie7 oldie" lang="en"><![endif]-->
<!--[if IE 8]><html class="no-js ie8 oldie" lang="en"><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width,initial-scale=1">

        
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-3494213-5', 'auto');
ga('send', 'pageview');
</script>


        
        <link rel="stylesheet" href="/css/styles.css?2017-10-02%2009%3a30%3a50.17822679%20%2b0100%20BST" type="text/css" />
        <link rel="stylesheet" href="/css/pygments.css" type="text/css" />

        
        <link rel="alternate" href="/index.xml" type="application/rss+xml" title="David Winterbottom">

        
        <link href='http://fonts.googleapis.com/css?family=Signika+Negative:600' rel='stylesheet' type='text/css' />

        
        
        <title>Prefer WebTest to Django&#39;s test client for functional tests - David Winterbottom</title>
        <meta name="author" content="David Winterbottom">
        <meta name="description" content="Superior functional tests for Django">

    </head>

    <body>

        <article class="hentry" id="container">

<header>
    <div id="article_nav">
        <h5>
            <a href="/">home</a> | 
            <a href="/writing/">writing</a> | 
            <a href="http://twitter.com/codeinthehole" title="Occasionally I say something interesting">tweets</a> | 
            <a href="/about/">about</a>
        </h5>
    </div>
</header>



<div id="main" role="main">

    <div id="content" class="article">

        <h1 id="article_title" class="entry-title">Prefer WebTest to Django&#39;s test client for functional tests</h1>

        <div class="byline desktop_only">
            by <a href="/about/" class="author vcard">David Winterbottom</a>
            on <time class="published" datetime="">Sunday, 9 September 2012</time>
        </div>
        <div class="byline mobile_only">
            by <a href="/about/" class="author vcard">David Winterbottom</a><br/>
            <span class="article_date">on <time class="published" datetime="">Sunday, 9 September 2012</time></span>
        </div>

        <div id="article_content" class="entry-content">
            

<p>Since watching Carl Meyer&rsquo;s superb &lsquo;<a href="http://pyvideo.org/video/699/testing-and-django">Testing and
Django</a>&rsquo; talk, I&rsquo;ve
been using Ian Bicking&rsquo;s
<a href="http://webtest.pythonpaste.org/en/latest/index.html">WebTest</a> library
for functional tests, via
<a href="http://pypi.python.org/pypi/django-webtest">django-webtest</a>. I&rsquo;ve been
really impressed and I&rsquo;d like to stress one of Carl&rsquo;s points - that
using WebTest for functional tests is superior to using the Django
client.</p>

<h3 id="why">Why?</h3>

<p>Several reasons - here&rsquo;s a few:</p>

<ul>
<li>WebTest allows you to model a user&rsquo;s experience much more closely as
it is smart about mark-up. Instead of hand-crafting GET and POST
requests, you can use the WebTest API to follow links and submit
forms - this is what users actually do. As a result, your tests
accurately capture user stories.</li>
<li>A corollary to the last point is that writing functional tests with
WebTest is both easier and quicker than using Django&rsquo;s test client.
It&rsquo;s much simpler to fill in forms that construct complicated arrays
of POST data - this is particularly noticable with formsets.</li>
<li>The WebTest response object supports <a href="http://webtest.pythonpaste.org/en/latest/index.html#parsing-the-body">several ways of parsing the
response
HTML</a>,
making it easy to make complicated assertions about the response.</li>
</ul>

<p>Watch from 29:48 in Carl&rsquo;s talk for further details.</p>

<h3 id="example-functional-test">Example functional test</h3>

<p>Consider this story from a functional spec:</p>

<blockquote>
<p>A staff member can upload a CSV to create new credit allocations for
customers.</p>
</blockquote>

<p>Here&rsquo;s a WebTest for this:</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f92672">from</span> <span style="color: #f8f8f2">django_webtest</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">WebTest</span>
<span style="color: #f92672">from</span> <span style="color: #f8f8f2">django.core.urlresolvers</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">reverse</span>
<span style="color: #f92672">from</span> <span style="color: #f8f8f2">django.contrib.auth.models</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">User</span>
<span style="color: #f92672">from</span> <span style="color: #f8f8f2">django_dynamic_fixture</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">G</span>

<span style="color: #f92672">from</span> <span style="color: #f8f8f2">myproject.credits</span> <span style="color: #f92672">import</span> <span style="color: #f8f8f2">api</span>


<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">TestAnAdmin</span><span style="color: #f8f8f2">(WebTest):</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">setUp</span><span style="color: #f8f8f2">(self):</span>
        <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">staff</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">G(User,</span> <span style="color: #f8f8f2">is_staff</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">True)</span>
        <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">customer</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">G(User,</span> <span style="color: #f8f8f2">username</span><span style="color: #f92672">=</span><span style="color: #e6db74">&#39;10000&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">is_staff</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">False)</span>

    <span style="color: #66d9ef">def</span> <span style="color: #a6e22e">test_can_upload_a_csv_to_create_allocations</span><span style="color: #f8f8f2">(self):</span>
        <span style="color: #f8f8f2">index</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">app</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">get(reverse(</span><span style="color: #e6db74">&#39;credits-index&#39;</span><span style="color: #f8f8f2">),</span> <span style="color: #f8f8f2">user</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">staff)</span>

        <span style="color: #75715e"># Specify the file content to upload and submit the form</span>
        <span style="color: #f8f8f2">form</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">index</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">forms[</span><span style="color: #e6db74">&#39;upload_form&#39;</span><span style="color: #f8f8f2">]</span>
        <span style="color: #75715e"># CSV content should be: username, credits, start_date, end_date</span>
        <span style="color: #f8f8f2">content</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&quot;10000,250,2012-01-01,2013-01-01&quot;</span>
        <span style="color: #f8f8f2">form[</span><span style="color: #e6db74">&#39;file&#39;</span><span style="color: #f8f8f2">]</span> <span style="color: #f92672">=</span> <span style="color: #e6db74">&#39;credits.csv&#39;</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">content</span>
        <span style="color: #f8f8f2">form</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">submit()</span>

        <span style="color: #75715e"># Check that an allocation has been created</span>
        <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">assertEqual(</span><span style="color: #ae81ff">250</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">api</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">balance(customer))</span>
        <span style="color: #f8f8f2">self</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">assertEqual(</span><span style="color: #ae81ff">1</span><span style="color: #f8f8f2">,</span> <span style="color: #f8f8f2">api</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">allocations(customer)</span><span style="color: #f92672">.</span><span style="color: #f8f8f2">count())</span>
</pre></div>

<p>As you can see, using WebTest allows the story to be captured in a
simple and readable test. This is based on a real functional test from a
current project of mine. Writing the above test took about 2 minutes.</p>

<h4 id="other-useful-testing-libraries">Other useful testing libraries</h4>

<p>The example test uses
<a href="http://paulocheque.github.com/django-dynamic-fixture/">django_dynamic_fixture</a>
to create users, specifying only the attributes relevant to the test.</p>

<p>Note also the mildly unusual naming convention of the example TestCase
and method are because I use
<a href="https://github.com/jbalogh/django-nose">django_nose</a> with the &lsquo;spec&rsquo;
plugin from the
<a href="http://darcs.idyll.org/~t/projects/pinocchio/doc/">pinocchio</a> library.
This causes the nose output to read like the stories from your
functional spec:</p>
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>$ ./manage.py <span style="color: #f8f8f2">test</span> tests/functional/eshop/credits_tests.py

nosetests --verbosity <span style="color: #ae81ff">1</span> tests/functional/eshop/credits_tests.py --with-spec -x -s

An admin
- can upload a csv to create allocations

----------------------------------------------------------------------
Ran <span style="color: #ae81ff">1</span> tests in <span style="color: #ae81ff">0</span>.269s
</pre></div>

<p>This is a useful way of running functional tests. It also pushes you
towards splitting your tests suites into more carefully named,
tightly-focussed test cases - rather than bundling disparate tests into
the same test case.</p>

<h3 id="summary">Summary</h3>

<p>Use WebTest for your functional tests - you won&rsquo;t regret it.</p>

        </div>

        <div id="article_meta">
            <span class="hr">----</span>
            <p>
            Something wrong? 
            <a href="https://github.com/codeinthehole/codeinthehole.hugo/edit/master/content/tips/django-webtest-is-awesome.md">Suggest an improvement</a>
            or 
            <a href="https://github.com/codeinthehole/codeinthehole.hugo/issues/new?title=Comment%20on%20%22Prefer%20WebTest%20to%20Django%27s%20test%20client%20for%20functional%20tests%22&body=Article:%20Prefer%20WebTest%20to%20Django%27s%20test%20client%20for%20functional%20tests%0AURL:%20http%3a%2f%2fcodeinthehole.com%2ftips%2fprefer-webtest-to-djangos-test-client-for-functional-tests%2f">add a comment</a>
            (see <a href="https://github.com/codeinthehole/codeinthehole.hugo/commits/master/content/tips/django-webtest-is-awesome.md">article history</a>)<br/>

            
                Tagged with:
                
                 <a href="/tags/django">django</a>, <a href="/tags/testing">testing</a>
                <br/>
            
            
                Filed in: <a href="/tips/">tips</a>
            
            </p>

            <p>
            
                Previous: <a href="/projects/cacheback-asynchronous-cache-refreshing-for-django/">Cacheback - asynchronous cache refreshing for Django</a><br/>
            
            
                Next: <a href="/tips/how-to-chroot-a-user-in-ubuntu-1204/">How to chroot a user in Ubuntu 12.04</a>
            
            </p>

            <p>
            Copyright &copy; 2005-2017 <a href="/about/">David Winterbottom</a><br/>
            Content licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a>.
            </p>
        </div>
    </div>

</div>

        </article>
    </body>
</html>


